function LogoInterpreter(turtle,stream){function format(e,t){return e.replace(/\{(\w+)\}/g,function(e,n){return t[n]})}function __(e){return e}function to_arity(func,arity){var parms=[];if(func.length===arity){return func}for(var i=0;i<arity;i+=1){parms.push("a"+i)}var f=eval("f = (function "+func.name+"("+parms.join(",")+") { return func.apply(this, arguments); })");return f}function PRNG(e){var t=e&2147483647,n=48271,r=2147483647,i=r/n,s=r%n;this.next=function(){var o=t/i,u=t%i,a=n*u-s*o;t=a>0?a:a+r;this.last=t/r;return this.last};this.seed=function(n){t=n&2147483647};this.next()}function StringMap(){var e=Object.create(null);return{get:function(t){return e["$"+t]},set:function(t,n){e["$"+t]=n},has:function(t){return"$"+t in e},"delete":function(t){return delete e["$"+t]},keys:function(){return Object.keys(e).map(function(e){return e.substring(1)})}}}function Output(e){this.output=e}function Bye(){}function Type(e){if(e===void 0){throw new Error(__("No output from procedure"))}else if(typeof e==="string"){return"word"}else if(typeof e==="number"){return"number"}else if(Array.isArray(e)){return"list"}else if(!e){throw new Error(__("Unexpected value: null"))}else{throw new Error(__("Unexpected value: unknown type"))}}function parse(e){if(e===void 0){return void 0}var t=[],n,r;e=e.replace(/^(([^;\\\n]|\\.)*);.*$/mg,"$1").replace(/\\(.)/g,"$1");e=e.replace(/\r/g,"").replace(/\n/g," ");e=e.replace(/^\s+/,"").replace(/\s+$/,"");while(e!==void 0&&e!==""){var i;var s=/^\s+/.test(e);e=e.replace(/^\s+/,"");if(e.match(regexIdentifier)||e.match(regexStringLiteral)||e.match(regexVariableLiteral)||e.match(regexNumberLiteral)){i=RegExp.$1;e=RegExp.$2}else if(e.charAt(0)==="["){r=parseList(e.substring(1));i=r.list;e=r.string}else if(e.match(regexOperator)){i=RegExp.$1;e=RegExp.$2;if(i==="-"){var o=/^\s+/.test(e);if(n===void 0||Type(n)==="word"&&regexInfix.test(n)||Type(n)==="word"&&n==="("||s&&!o){i=UNARY_MINUS}}}else{throw new Error(format(__("Couldn't parse: '{string}'"),{string:e}))}t.push(i);n=i}return t}function isNumber(e){return String(e).match(/^-?([0-9]*\.?[0-9]+(?:[eE]\s*[\-+]?\s*[0-9]+)?)$/)}function isWS(e){return e===" "||e==="	"||e==="\r"||e==="\n";}function parseList(e){var t=0,n=[],r="",i;while(true){do{i=e.charAt(t++)}while(isWS(i));while(!isWS(i)&&i!=="["&&i!=="]"&&i!==""){r+=i;i=e.charAt(t++)}if(r.length){n.push(r);r=""}if(i===""){throw new Error(__("Expected ']'"))}if(i==="]"){return{list:n,string:e.substring(t)}}if(i==="["){var s=parseList(e.substring(t));n.push(s.list);e=s.string;t=0}}}function reparse(e){return parse(stringify_nodecorate(e).replace(/([\\;])/g,"\\$1"))}function peek(e,t){if(e.length<1){return false}var n=e[0];return t.some(function(e){return n===e})}function aexpr(e){if(e===void 0){throw new Error(__("Expected number"))}if(Type(e)==="number"){return e}if(Type(e)==="word"&&isNumber(e)){return parseFloat(e)}throw new Error(__("Expected number"))}function sexpr(e){if(e===void 0){throw new Error(__("Expected string"))}if(e===UNARY_MINUS){return"-"}if(Type(e)==="word"){return e}if(Type(e)==="number"){return String(e)}throw new Error(__("Expected string"))}function lexpr(e){if(e===void 0){throw new Error(__("Expected list"))}if(Type(e)==="word"){return[].slice.call(e)}if(Type(e)==="list"){return copy(e)}throw new Error(__("Expected list"))}function copy(e){switch(Type(e)){case"list":return e.map(copy);default:return e}}function mapreduce(e,t,n,r){if(r===void 0){return Array.prototype.reduce.call(Array.prototype.map.call(e,t),n)}else{return Array.prototype.reduce.call(Array.prototype.map.call(e,t),n,r)}}function stringify(e){if(Type(e)==="list"){return"[ "+e.map(stringify).join(" ")+" ]"}else{return sexpr(e)}}function stringify_nodecorate(e){if(Type(e)==="list"){return e.map(stringify).join(" ")}else{return stringify(e)}}function deg2rad(e){return e/180*Math.PI}function rad2deg(e){return e*180/Math.PI}function truncate(e){return parseInt(e,10)}function checkevalblock(e){e=e();if(Type(e)==="list"){return e}throw new Error(__("Expected block"))}var self=this;var UNARY_MINUS="<UNARYMINUS>";self.turtle=turtle;self.stream=stream;self.routines={};self.scopes=[new StringMap];self.plists=new StringMap;self.prng=new PRNG(Math.random()*2147483647);self.queuedscopes=[];Output.prototype.toString=function(){return this.output};Output.prototype.valueOf=function(){return this.output};var regexIdentifier=/^(\.?[A-Za-zא-ת\u4E00-\u9FA5\u0100-\u04FF\u0E00-\u0E5B\u0600-\u06FF\u00F9-\u00FF][A-Za-zא-ת\u4E00-\u9FA5\u0100-\u04FF0u0E00-\u0E5B\u0600-\u06FF-9_.\?]*)(.*?)$/;var regexStringLiteral=/^("[^ \[\]\(\)]*)(.*?)$/;var regexVariableLiteral=/^(:[A-Za-zא-ת][A-Za-zא-ת0-9]*)(.*?)$/;var regexNumberLiteral=/^([0-9]*\.?[0-9]+(?:[eE]\s*[\-+]?\s*[0-9]+)?)(.*?)$/;var regexListDelimiter=/^(\[|\])(.*?)$/;var regexHasNumber=/([0-9])$/;var regexOperator=/^(\+|\-|\*|\/|%|\^|>=|<=|<>|=|<|>|\[|\]|\(|\))(.*?)$/;var regexInfix=/^(\+|\-|\*|\/|%|\^|>=|<=|<>|=|<|>)$/;self.parse=function(e){return parse(e)};self.maybegetvar=function(e){e=e.toLowerCase();for(var t=self.scopes.length-1;t>=0;--t){if(typeof self.scopes[t].has!="undefined")if(self.scopes[t].has(e)){return self.scopes[t].get(e).value}}return void 0};self.getvar=function(e){e=e.toLowerCase();var t=self.maybegetvar(e);if(t!==void 0){return t}throw new Error(format(__("Don't know about variable {name}"),{name:e.toUpperCase()}))};self.getlvalue=function(e){e=e.toLowerCase();for(var t=self.scopes.length-1;t>=0;--t){if(self.scopes[t].has(e)){return self.scopes[t].get(e)}}throw new Error(format(__("Don't know about variable {name}"),{name:e.toUpperCase()}))};self.setvar=function(e,t){e=e.toLowerCase();t=copy(t);for(var n=self.scopes.length-1;n>=0;--n){if(self.scopes[n].has(e)){self.scopes[n].get(e).value=t;return}}var r={value:t};self.scopes[0].set(e,r)};self.evaluateExpression=function(e){return self.expression(e)()};self.expression=function(e){return self.relationalExpression(e)};self.relationalExpression=function(e){var t=self.additiveExpression(e);var n;while(peek(e,["=","<",">","<=",">=","<>"])){n=e.shift();t=function(t){var r=self.additiveExpression(e);switch(n){case"<":return function(){return aexpr(t())<aexpr(r())?1:0};case">":return function(){return aexpr(t())>aexpr(r())?1:0};case"=":return function(){return self.equal(t(),r())?1:0};case"<=":return function(){return aexpr(t())<=aexpr(r())?1:0};case">=":return function(){return aexpr(t())>=aexpr(r())?1:0};case"<>":return function(){return!self.equal(t(),r())?1:0};default:throw new Error(__("Internal error in expression parser"))}}(t)}return t};self.additiveExpression=function(e){var t=self.multiplicativeExpression(e);var n;while(peek(e,["+","-"])){n=e.shift();t=function(t){var r=self.multiplicativeExpression(e);switch(n){case"+":return function(){return aexpr(t())+aexpr(r())};case"-":return function(){return aexpr(t())-aexpr(r())};default:throw new Error(__("Internal error in expression parser"))}}(t)}return t};self.multiplicativeExpression=function(e){var t=self.powerExpression(e);var n;while(peek(e,["*","/","%"])){n=e.shift();t=function(t){var r=self.powerExpression(e);switch(n){case"*":return function(){return aexpr(t())*aexpr(r())};case"/":return function(){var e=aexpr(t()),n=aexpr(r());if(n===0){throw new Error(__("Division by zero"))}return e/n};case"%":return function(){var e=aexpr(t()),n=aexpr(r());if(n===0){throw new Error(__("Division by zero"))}return e%n};default:throw new Error(__("Internal error in expression parser"))}}(t)}return t};self.powerExpression=function(e){var t=self.unaryExpression(e);var n;while(peek(e,["^"])){n=e.shift();t=function(t){var n=self.unaryExpression(e);return function(){return Math.pow(aexpr(t()),aexpr(n()))}}(t)}return t};self.unaryExpression=function(e){var t,n;if(peek(e,[UNARY_MINUS])){n=e.shift();t=self.unaryExpression(e);return function(){return-aexpr(t())}}else{return self.finalExpression(e)}};self.finalExpression=function(e){if(!e.length){throw new Error(__("Unexpected end of instructions"))}var t=e.shift();var n,r,i,s;var o,u;switch(Type(t)){case"number":throw new Error(__("Unexpected atom type: number"));case"list":return function(){return t};case"word":if(isNumber(t)){t=parseFloat(t);return function(){return t}}else if(t.charAt(0)==='"'){o=t.substring(1);return function(){return o}}else if(t.charAt(0)===":"){u=t.substring(1);return function(){return self.getvar(u)}}else if(t==="("){if(e.length&&Type(e[0])==="word"&&self.routines[String(e[0]).toLowerCase()]){t=e.shift();return self.dispatch(t,e,false)}else{s=self.expression(e);if(!e.length){throw new Error(format(__("Expected ')'")))}else if(!peek(e,[")"])){throw new Error(format(__("Expected ')', saw {word}"),{word:e.shift()}))}e.shift();return s}}else{return self.dispatch(t,e,true)}break;default:throw new Error(__("Internal error in expression parser"))}};self.dispatch=function(e,t,n){var r=self.routines[e.toLowerCase()];if(!r){if(e.match(regexHasNumber))throw new Error(format(__(gt["Command and number should be seperate by space e.g forward 50 and not forward50"]),{name:e.toUpperCase()}));else throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(r.special){r(t);return function(){}}var i=[];if(n){for(var s=0;s<r.length;++s){i.push(self.expression(t))}}else{while(t.length&&!peek(t,[")"])){i.push(self.expression(t))}t.shift()}if(r.noeval){return function(){return r.apply(null,i)}}else{return function(){return r.apply(null,i.map(function(e){return e()}))}}};self.equal=function(e,t,n){if(Array.isArray(e)){if(!Array.isArray(t)){return false}if(e.length!==t.length){return false}for(var r=0;r<e.length;r+=1){if(!self.equal(e[r],t[r])){return false}}return true}else if(typeof e!==typeof t){return false}else if(n!==void 0&&typeof e==="number"){return Math.abs(e-t)<n}else{return e===t}};self.waitexecute=function(){self.wait=false;console.log("wait executing");console.log(self.queuedscopes);if(self.queuedscopes.length>0){self.scopes=self.queuedscopes.shift()}console.log(self.scopes);self.execute(self.queue);if(self.turtle){self.turtle.begin();self.turtle.end()}};self.execute=function(e,t){t=Object(t);e=e.slice();var n;if(self.wait){self.queue=self.queue.concat(e);self.queuedscopes.push(JSON.parse(JSON.stringify(self.scopes)));console.log(self.queuedscopes);return}while(e.length){if(e[0]=="wait"){e.shift();self.queue=e.slice();self.wait=true;setTimeout(function(){self.waitexecute()},200);return n}n=self.evaluateExpression(e);if(n!==void 0&&!t.returnResult){throw new Error(format(__("Don't know what to do with {result}"),{result:n}))}}return n};self.setRatio=function(e){ratio=e};self.run=function(e,t){t=Object(t);if(self.turtle){self.turtle.begin()}try{var n=parse(e);return self.execute(n,t)}catch(r){if(r instanceof Bye){return void 0}else{throw r}}finally{if(self.turtle){self.turtle.end()}}};self.definition=function(e,t){function n(e){switch(Type(e)){case"word":return e;case"number":return String(e);case"list":return"[ "+e.map(n).join(" ")+" ]";default:throw new Error(__("Unexpected value: unknown type"))}}var r="to "+e+" ";if(t.inputs.length){r+=t.inputs.map(function(e){return":"+e}).join(" ");r+=" "}r+=t.block.map(n).join(" ").replace(new RegExp(UNARY_MINUS+" ","g"),"-");r+=" end";return r};self.procdefs=function(){var e=[];Object.keys(self.routines).forEach(function(t){var n=self.routines[t];if(!n.primitive){e.push(self.definition(t,n))}});return e.join("\n")};self.routines["to"]=function(e){var t=sexpr(e.shift());if(!t.match(regexIdentifier)){throw new Error(__("Expected identifier"))}t=t.toLowerCase();if(typeof self.routines[t]!=="undefined"&&self.routines[t].primitive){throw gt["Please don't try to override primitive functions"]}var n=[];var r=[];var i=true,s=false;while(e.length){var o=e.shift();var u=gt[o];if(Type(o)==="word"&&typeof u!="undefined"&&(u.toUpperCase()==="END"||u.toUpperCase()===gt["end"].toUpperCase())){s=true;break}else if(i&&Type(o)==="word"&&o.charAt(0)===":"){n.push(o.substring(1))}else{i=false;r.push(o)}}if(!s){throw new Error(__("Expected END"))}var a=function(){var e=new StringMap;for(var t=0;t<n.length&&t<arguments.length;t+=1){e.set(n[t],{value:arguments[t]})}self.scopes.push(e);try{try{return self.execute(r)}catch(i){if(i instanceof Output){return i.output}else{throw i}}}finally{self.scopes.pop()}};self.routines[t]=to_arity(a,n.length);self.routines[t].inputs=n;self.routines[t].block=r};self.routines["to"].special=true;self.routines["def"]=function(e){var t=sexpr(e).toLowerCase();var n=self.routines[t];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:t.toUpperCase()}))}if(!n.inputs){throw new Error(format(__("Can't show definition of primitive {name}"),{name:t.toUpperCase()}))}return self.definition(t,n)};self.routines["word"]=function(e,t){return arguments.length?mapreduce(arguments,sexpr,function(e,t){return e+" "+t}):""};self.routines["list"]=function(e,t){return Array.prototype.map.call(arguments,function(e){return e})};self.routines["sentence"]=self.routines["se"]=function(e,t){var n=[];for(var r=0;r<arguments.length;r+=1){var i=arguments[r];if(Type(i)==="list"){i=lexpr(i);n=n.concat(i)}else{n.push(i)}}return n};self.routines["fput"]=function(e,t){t=lexpr(t);t.unshift(e);return t};self.routines["lput"]=function(e,t){t=lexpr(t);t.push(e);return t};self.routines["combine"]=function(e,t){if(Type(t)!=="list"){return self.routines["word"](e,t)}else{return self.routines["fput"](e,t)}};self.routines["reverse"]=function(e){return lexpr(e).reverse()};var gensym_index=0;self.routines["gensym"]=function(){gensym_index+=1;return"G"+gensym_index};self.routines["first"]=function(e){return lexpr(e)[0]};self.routines["firsts"]=function(e){return lexpr(e).map(function(e){return e[0]})};self.routines["last"]=function(e){e=lexpr(e);return e[e.length-1]};self.routines["butfirst"]=self.routines["bf"]=function(e){return lexpr(e).slice(1)};self.routines["butfirsts"]=self.routines["bfs"]=function(e){return lexpr(e).map(function(e){return lexpr(e).slice(1)})};self.routines["butlast"]=self.routines["bl"]=function(e){return lexpr(e).slice(0,-1)};self.routines["item"]=function(e,t){e=aexpr(e);if(e<1||e>t.length){throw new Error(__("Index out of bounds"))}return lexpr(t)[e-1]};self.routines["pick"]=function(e){e=lexpr(e);var t=Math.floor(self.prng.next()*e.length);return e[t]};self.routines["remove"]=function(e,t){return lexpr(t).filter(function(t){return!self.equal(t,e)})};self.routines["remdup"]=function(e){var t=Object.create(null);return lexpr(e).filter(function(e){if(!t[e]){t[e]=true;return true}else{return false}})};self.routines["push"]=function(e,t){var n=lexpr(self.getvar(e));n.unshift(t);self.setvar(e,n)};self.routines["pop"]=function(e){return self.getvar(e).shift()};self.routines["queue"]=function(e,t){var n=lexpr(self.getvar(e));n.push(t);self.setvar(e,n)};self.routines["dequeue"]=function(e){return self.getvar(e).pop()};self.routines["wordp"]=self.routines["word?"]=function(e){return Type(e)==="word"?1:0};self.routines["listp"]=self.routines["list?"]=function(e){return Type(e)==="list"?1:0};self.routines["numberp"]=self.routines["number?"]=function(e){return Type(e)==="number"?1:0};self.routines["numberwang"]=function(e){return self.prng.next()<.5?1:0};self.routines["equalp"]=self.routines["equal?"]=function(e,t){return self.equal(e,t)?1:0};self.routines["notequalp"]=self.routines["notequal?"]=function(e,t){return!self.equal(e,t)?1:0};self.routines["emptyp"]=self.routines["empty?"]=function(e){return lexpr(e).length===0?1:0};self.routines["beforep"]=self.routines["before?"]=function(e,t){return sexpr(e)<sexpr(t)?1:0};self.routines["memberp"]=self.routines["member?"]=function(e,t){return lexpr(t).some(function(t){return self.equal(t,e)})?1:0};self.routines["substringp"]=self.routines["substring?"]=function(e,t){return sexpr(t).indexOf(sexpr(e))!==-1?1:0};self.routines["count"]=function(e){return lexpr(e).length};self.routines["ascii"]=function(e){return sexpr(e).charCodeAt(0)};self.routines["char"]=function(e){return String.fromCharCode(aexpr(e))};self.routines["lowercase"]=function(e){return sexpr(e).toLowerCase()};self.routines["uppercase"]=function(e){return sexpr(e).toUpperCase()};self.routines["standout"]=function(e){return sexpr(e)};self.routines["print"]=self.routines["pr"]=function(e){var t=Array.prototype.map.call(arguments,stringify_nodecorate).join(" ");self.stream.write(t,"\n")};self.routines["type"]=function(e){var t=Array.prototype.map.call(arguments,stringify_nodecorate).join("");self.stream.write(t)};self.routines["show"]=function(e){var t=Array.prototype.map.call(arguments,stringify).join(" ");self.stream.write(t,"\n")};self.routines["readword"]=function(){if(arguments.length>0){return stream.read(sexpr(arguments[0]))}else{return stream.read()}};self.routines["cleartext"]=self.routines["ct"]=function(){self.stream.clear()};self.routines["sum"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return e+t},0)};self.routines["difference"]=function(e,t){return aexpr(e)-aexpr(t)};self.routines["minus"]=function(e){return-aexpr(e)};self.routines["product"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return e*t},1)};self.routines["quotient"]=function(e,t){if(t!==void 0){return aexpr(e)/aexpr(t)}else{return 1/aexpr(e)}};self.routines["remainder"]=function(e,t){return aexpr(e)%aexpr(t)};self.routines["modulo"]=function(e,t){e=aexpr(e);t=aexpr(t);return Math.abs(e%t)*(t<0?-1:1)};self.routines["power"]=function(e,t){return Math.pow(aexpr(e),aexpr(t))};self.routines["sqrt"]=function(e){return Math.sqrt(aexpr(e))};self.routines["exp"]=function(e){return Math.exp(aexpr(e))};self.routines["log10"]=function(e){return Math.log(aexpr(e))/Math.LN10};self.routines["ln"]=function(e){return Math.log(aexpr(e))};self.routines["arctan"]=function(e){if(arguments.length>1){var t=aexpr(arguments[0]);var n=aexpr(arguments[1]);return rad2deg(Math.atan2(n,t))}else{return rad2deg(Math.atan(aexpr(e)))}};self.routines["sin"]=function(e){return Math.sin(deg2rad(aexpr(e)))};self.routines["cos"]=function(e){return Math.cos(deg2rad(aexpr(e)))};self.routines["tan"]=function(e){return Math.tan(deg2rad(aexpr(e)))};self.routines["radarctan"]=function(e){if(arguments.length>1){var t=aexpr(arguments[0]);var n=aexpr(arguments[1]);return Math.atan2(n,t)}else{return Math.atan(aexpr(e))}};self.routines["radsin"]=function(e){return Math.sin(aexpr(e))};self.routines["radcos"]=function(e){return Math.cos(aexpr(e))};self.routines["radtan"]=function(e){return Math.tan(aexpr(e))};self.routines["abs"]=function(e){return Math.abs(aexpr(e))};self.routines["int"]=function(e){return truncate(aexpr(e))};self.routines["round"]=function(e){return Math.round(aexpr(e))};self.routines["iseq"]=function(e,t){e=truncate(aexpr(e));t=truncate(aexpr(t));var n=e<t?1:-1;var r=[];for(var i=e;n>0?i<=t:i>=t;i+=n){r.push(i)}return r};self.routines["rseq"]=function(e,t,n){e=aexpr(e);t=aexpr(t);n=truncate(aexpr(n));var r=(t-e)/(n-1);var i=[];for(var s=e;r>0?s<=t:s>=t;s+=r){i.push(s)}return i};self.routines["greaterp"]=self.routines["greater?"]=function(e,t){return aexpr(e)>aexpr(t)?1:0};self.routines["greaterequalp"]=self.routines["greaterequal?"]=function(e,t){return aexpr(e)>=aexpr(t)?1:0};self.routines["lessp"]=self.routines["less?"]=function(e,t){return aexpr(e)<aexpr(t)?1:0};self.routines["lessequalp"]=self.routines["lessequal?"]=function(e,t){return aexpr(e)<=aexpr(t)?1:0};self.routines["random"]=function(e){e=aexpr(e);return Math.floor(self.prng.next()*e)};self.routines["rerandom"]=function(){var e=arguments.length>0?aexpr(arguments[0]):2345678901;return self.prng.seed(e)};self.routines["form"]=function(e,t,n){e=aexpr(e);t=aexpr(t);n=aexpr(n);var r=e.toFixed(n);if(r.length<t){r=Array(1+t-r.length).join(" ")+r}return r};self.routines["bitand"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return e&t},-1)};self.routines["bitor"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return e|t},0)};self.routines["bitxor"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return e^t},0)};self.routines["bitnot"]=function(e){return~aexpr(e)};self.routines["ashift"]=function(e,t){e=truncate(aexpr(e));t=truncate(aexpr(t));return t>=0?e<<t:e>>-t};self.routines["lshift"]=function(e,t){e=truncate(aexpr(e));t=truncate(aexpr(t));return t>=0?e<<t:e>>>-t};self.routines["true"]=function(){return 1};self.routines["false"]=function(){return 0};self.routines["and"]=function(e,t){return Array.prototype.every.call(arguments,function(e){return e()})?1:0};self.routines["and"].noeval=true;self.routines["or"]=function(e,t){return Array.prototype.some.call(arguments,function(e){return e()})?1:0};self.routines["or"].noeval=true;self.routines["xor"]=function(e,t){return mapreduce(arguments,aexpr,function(e,t){return Boolean(e)!==Boolean(t)},0)?1:0};self.routines["not"]=function(e){return!aexpr(e)?1:0};self.routines["saveimage"]=function(){turtle.saveimage()};self.routines["forward"]=self.routines["fd"]=function(e){turtle.move(aexpr(e*ratio))};self.routines["back"]=self.routines["bk"]=function(e){turtle.move(-aexpr(e*ratio))};self.routines["left"]=self.routines["lt"]=function(e){turtle.turn(-aexpr(e))};self.routines["right"]=self.routines["rt"]=function(e){turtle.turn(aexpr(e))};self.routines["setpos"]=function(e){e=lexpr(e);if(e.length!==2){throw new Error(__("Expected list of length 2"))}turtle.setposition(aexpr(e[0]),aexpr(e[1]))};self.routines["setxy"]=function(e,t){turtle.setposition(aexpr(e*ratio),aexpr(t*ratio))};self.routines["setx"]=function(e){turtle.setposition(aexpr(e*ratio),void 0)};self.routines["sety"]=function(e){turtle.setposition(void 0,aexpr(e*ratio))};self.routines["setheading"]=self.routines["seth"]=function(e){turtle.setheading(aexpr(e))};self.routines["home"]=function(){turtle.home()};self.routines["arc"]=function(e,t){turtle.arc(aexpr(e),aexpr(t))};self.routines["pos"]=function(){var e=turtle.getxy();return[e[0],e[1]]};self.routines["xcor"]=function(){var e=turtle.getxy();return e[0]};self.routines["ycor"]=function(){var e=turtle.getxy();return e[1]};self.routines["heading"]=function(){return turtle.getheading()};self.routines["towards"]=function(e){e=lexpr(e);if(e.length!==2){throw new Error(__("Expected list of length 2"))}return turtle.towards(aexpr(e[0]),aexpr(e[1]))};self.routines["showturtle"]=self.routines["st"]=function(){turtle.showturtle()};self.routines["hideturtle"]=self.routines["ht"]=function(){turtle.hideturtle()};self.routines["clean"]=function(){turtle.clear()};self.routines["clearscreen"]=self.routines["cs"]=function(){turtle.clearscreen()};self.routines["wrap"]=function(){turtle.setturtlemode("wrap")};self.routines["window"]=function(){turtle.setturtlemode("window")};self.routines["fence"]=function(){turtle.setturtlemode("fence")};self.routines["fill"]=function(){turtle.fill()};self.routines["filled"]=function(e,t){e=sexpr(e);t=reparse(lexpr(t));turtle.beginpath();try{self.execute(t)}finally{turtle.fillpath(e)}};self.routines["label"]=function(e){var t=Array.prototype.map.call(arguments,stringify_nodecorate).join(" ");turtle.drawtext(t)};self.routines["setlabelheight"]=function(e){turtle.setfontsize(aexpr(e*ratio))};self.routines["shownp"]=self.routines["shown?"]=function(){return turtle.isturtlevisible()?1:0};self.routines["turtlemode"]=function(){return turtle.getturtlemode().toUpperCase()};self.routines["labelsize"]=function(){return[turtle.getfontsize(),turtle.getfontsize()]};self.routines["pendown"]=self.routines["pd"]=function(){turtle.pendown()};self.routines["penup"]=self.routines["pu"]=function(){turtle.penup()};self.routines["penpaint"]=self.routines["ppt"]=function(){turtle.setpenmode("paint")};self.routines["penerase"]=self.routines["pe"]=function(){turtle.setpenmode("erase")};self.routines["penreverse"]=self.routines["px"]=function(){turtle.setpenmode("reverse")};self.routines["setpencolor"]=self.routines["setpc"]=self.routines["setcolor"]=function(e){if(arguments.length===3){var t=Math.round(aexpr(arguments[0])*255/99);var n=Math.round(aexpr(arguments[1])*255/99);var r=Math.round(aexpr(arguments[2])*255/99);var i=(t<16?"0":"")+t.toString(16);var s=(n<16?"0":"")+n.toString(16);var o=(r<16?"0":"")+r.toString(16);turtle.setcolor("#"+i+s+o)}else{turtle.setcolor(sexpr(e))}};self.routines["setpensize"]=self.routines["setwidth"]=self.routines["setpw"]=function(e){if(Type(e)==="list"){turtle.setwidth(aexpr(e[0]))}else{turtle.setwidth(aexpr(e))}};self.routines["pendownp"]=self.routines["pendown?"]=function(){return turtle.ispendown()?1:0};self.routines["penmode"]=self.routines["pc"]=function(){return turtle.getpenmode().toUpperCase()};self.routines["pencolor"]=self.routines["pc"]=function(){return turtle.getcolor()};self.routines["pensize"]=function(){return[turtle.getwidth(),turtle.getwidth()]};self.routines["copydef"]=function(e,t){e=sexpr(e).toLowerCase();t=sexpr(t).toLowerCase();if(!self.routines.hasOwnProperty(t)){throw new Error(format(__("Don't know how to {name}"),{name:t.toUpperCase()}))}if(self.routines.hasOwnProperty(e)){if(self.routines[e].special){throw new Error(format(__("Can't overwrite special form {name}"),{name:e.toUpperCase()}))}if(self.routines[e].primitive&&!self.maybegetvar("redefp")){throw new Error(__("Can't overwrite primitives unless REDEFP is TRUE"))}}self.routines[e]=self.routines[t]};self.routines["make"]=function(e,t){self.setvar(sexpr(e),t)};self.routines["name"]=function(e,t){self.setvar(sexpr(t),e)};self.routines["local"]=function(e){var t=self.scopes[self.scopes.length-1];Array.prototype.forEach.call(arguments,function(e){t.set(sexpr(e).toLowerCase(),{value:void 0})})};self.routines["localmake"]=function(e,t){var n=self.scopes[self.scopes.length-1];n.set(sexpr(e).toLowerCase(),{value:t})};self.routines["thing"]=function(e){return self.getvar(sexpr(e))};self.routines["global"]=function(e){var t=self.scopes[0];Array.prototype.forEach.call(arguments,function(e){t.set(sexpr(e).toLowerCase(),{value:void 0})})};self.routines["pprop"]=function(e,t,n){e=sexpr(e).toLowerCase();t=sexpr(t).toLowerCase();var r=self.plists.get(e);if(!r){r=new StringMap;self.plists.set(e,r)}r.set(t,n)};self.routines["gprop"]=function(e,t){e=sexpr(e).toLowerCase();t=sexpr(t).toLowerCase();var n=self.plists.get(e);if(!n||!n.has(t)){return[]}return n.get(t)};self.routines["remprop"]=function(e,t){e=sexpr(e).toLowerCase();t=sexpr(t).toLowerCase();var n=self.plists.get(e);if(n){n["delete"](t);if(n.keys().length===0){self.plists["delete"](e)}}};self.routines["plist"]=function(e){e=sexpr(e).toLowerCase();var t=self.plists.get(e);if(!t){return[]}var n=[];t.keys().forEach(function(e){n.push(e);n.push(copy(t.get(e)))});return n};self.routines["procedurep"]=self.routines["procedure?"]=function(e){e=sexpr(e).toLowerCase();return typeof self.routines[e]==="function"?1:0};self.routines["primitivep"]=self.routines["primitive?"]=function(e){e=sexpr(e).toLowerCase();return typeof self.routines[e]==="function"&&self.routines[e].primitive?1:0};self.routines["definedp"]=self.routines["defined?"]=function(e){e=sexpr(e).toLowerCase();return typeof self.routines[e]==="function"&&!self.routines[e].primitive?1:0};self.routines["namep"]=self.routines["name?"]=function(e){try{return self.getvar(sexpr(e))!==void 0?1:0}catch(t){return 0}};self.routines["plistp"]=self.routines["plist?"]=function(e){e=sexpr(e).toLowerCase();return self.plists.has(e)?1:0};self.routines["contents"]=function(){return[Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&!self.routines[e].buried}),self.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return!t.get(e).buried}))},[]),self.plists.keys().filter(function(e){return!self.plists.get(e).buried})]};self.routines["buried"]=function(){return[Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&self.routines[e].buried}),self.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).buried}))},[]),self.plists.keys().filter(function(e){return self.plists.get(e).buried})]};self.routines["traced"]=function(){return[Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&self.routines[e].traced}),self.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).traced}))},[]),self.plists.keys().filter(function(e){return self.plists.get(e).traced})]};self.routines["stepped"]=function(){return[Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&self.routines[e].stepped}),self.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return t.get(e).stepped}))},[]),self.plists.keys().filter(function(e){return self.plists.get(e).stepped})]};self.routines["procedures"]=function(){return Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&!self.routines[e].buried})};self.routines["primitives"]=function(){return Object.keys(self.routines).filter(function(e){return self.routines[e].primitive&!self.routines[e].buried})};self.routines["globals"]=function(){var e=self.scopes[0];return e.keys().filter(function(t){return!e.get(t).buried})};self.routines["names"]=function(){return[[],self.scopes.reduce(function(e,t){return e.concat(t.keys().filter(function(e){return!t.get(e).buried}))},[])]};self.routines["plists"]=function(){return[[],[],self.plists.keys().filter(function(e){return!self.plists.get(e).buried})]};self.routines["namelist"]=function(e){if(Type(e)==="list"){e=lexpr(e)}else{e=[sexpr(e)]}return[[],e]};self.routines["pllist"]=function(e){if(Type(e)==="list"){e=lexpr(e)}else{e=[sexpr(e)]}return[[],[],e]};self.routines["erase"]=function(e){e=lexpr(e);if(e.length){var t=lexpr(e.shift());t.forEach(function(e){e=sexpr(e).toLowerCase();if(self.routines.hasOwnProperty(e)){if(self.routines[e].special){throw new Error(format(__("Can't ERASE special form {name}"),{name:e.toUpperCase()}))}if(!self.routines[e].primitive||self.maybegetvar("redefp")){delete self.routines[e]}else{throw new Error(__("Can't ERASE primitives unless REDEFP is TRUE"))}}})}if(e.length){var n=lexpr(e.shift());self.scopes.forEach(function(e){n.forEach(function(t){t=sexpr(t).toLowerCase();e["delete"](t)})})}if(e.length){var r=lexpr(e.shift());r.forEach(function(e){e=sexpr(e).toLowerCase();self.plists["delete"](e)})}};self.routines["erall"]=function(){Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&!self.routines[e].buried}).forEach(function(e){delete self.routines[e]});self.scopes.forEach(function(e){e.keys().filter(function(t){return!e.get(t).buried}).forEach(function(t){e["delete"](t)})});self.plists.keys().filter(function(e){return!self.plists.get(e).buried}).forEach(function(e){self.plists["delete"](e)})};self.routines["erps"]=function(){Object.keys(self.routines).filter(function(e){return!self.routines[e].primitive&&!self.routines[e].buried}).forEach(function(e){delete self.routines[e]})};self.routines["erns"]=function(){self.scopes.forEach(function(e){e.keys().filter(function(t){return!e.get(t).buried}).forEach(function(t){e["delete"](t)})})};self.routines["erpls"]=function(){self.plists.keys().filter(function(e){return!self.plists.get(e).buried}).forEach(function(e){self.plists["delete"](e)})};self.routines["ern"]=function(e){var t;if(Type(e)==="list"){t=lexpr(e)}else{t=[sexpr(e)]}self.scopes.forEach(function(e){t.forEach(function(t){t=sexpr(t).toLowerCase();e["delete"](t)})})};self.routines["erpl"]=function(e){var t;if(Type(e)==="list"){t=lexpr(e)}else{t=[sexpr(e)]}t.forEach(function(e){e=sexpr(e).toLowerCase();self.plists["delete"](e)})};self.routines["bury"]=function(e){e=lexpr(e);if(e.length){var t=lexpr(e.shift());t.forEach(function(e){e=sexpr(e).toLowerCase();if(self.routines.hasOwnProperty(e)){self.routines[e].buried=true}})}if(e.length){var n=lexpr(e.shift());self.scopes.forEach(function(e){n.forEach(function(t){t=sexpr(t).toLowerCase();if(e.has(t)){e.get(t).buried=true}})})}if(e.length){var r=lexpr(e.shift());r.forEach(function(e){e=sexpr(e).toLowerCase();if(self.plists.has(e)){self.plists.get(e).buried=true}})}};self.routines["buryall"]=function(){Object.keys(self.routines).forEach(function(e){self.routines[e].buried=true});self.scopes.forEach(function(e){e.keys().forEach(function(t){e.get(t).buried=true})});self.plists.keys().forEach(function(e){self.plists.get(e).buried=true})};self.routines["unbury"]=function(e){e=lexpr(e);if(e.length){var t=lexpr(e.shift());t.forEach(function(e){e=sexpr(e).toLowerCase();if(self.routines.hasOwnProperty(e)){self.routines[e].buried=false}})}if(e.length){var n=lexpr(e.shift());self.scopes.forEach(function(e){n.forEach(function(t){t=sexpr(t).toLowerCase();if(e.has(t)){e.get(t).buried=false}})})}if(e.length){var r=lexpr(e.shift());r.forEach(function(e){e=sexpr(e).toLowerCase();if(self.plists.has(e)){self.plists.get(e).buried=false}})}};self.routines["unburyall"]=function(){Object.keys(self.routines).forEach(function(e){self.routines[e].buried=false});self.scopes.forEach(function(e){e.keys().forEach(function(t){e.get(t).buried=false})});self.plists.keys().forEach(function(e){self.plists.get(e).buried=false})};self.routines["buriedp"]=self.routines["buried?"]=function(e){e=lexpr(e);var t;if(e.length){var n=lexpr(e.shift());if(n.length){t=sexpr(n[0]).toLowerCase();return self.routines.hasOwnProperty(t)&&self.routines[t].buried?1:0}}if(e.length){var r=lexpr(e.shift());if(r.length){t=sexpr(r[0]).toLowerCase();return self.scopes[0].has(t)&&self.scopes[0].get(t).buried?1:0}}if(e.length){var i=lexpr(e.shift());if(i.length){t=sexpr(i[0]).toLowerCase();return self.plists.has(t)&&self.plists.get(t).buried?1:0}}return 0};self.routines["run"]=function(e){e=reparse(lexpr(e));self.execute(e)};self.routines["runresult"]=function(e){e=reparse(lexpr(e));var t=self.execute(e,{returnResult:true});if(t!==void 0){return[t]}else{return[]}};self.routines["repeat"]=function(e,t){e=aexpr(e);t=reparse(lexpr(t));for(var n=1;n<=e;++n){var r=self.repcount;self.repcount=n;try{self.execute(t)}finally{self.repcount=r}}};self.routines["forever"]=function(e){e=reparse(lexpr(e));for(var t=1;true;++t){var n=self.repcount;self.repcount=t;try{self.execute(e)}finally{self.repcount=n}}};self.routines["repcount"]=function(){return self.repcount};self.routines["if"]=function(e,t){e=aexpr(e);t=reparse(lexpr(t));if(e){self.execute(t)}};self.routines["ifelse"]=function(e,t,n){e=aexpr(e);t=reparse(lexpr(t));n=reparse(lexpr(n));self.execute(e?t:n)};self.routines["test"]=function(e){e=aexpr(e);self.scopes[self.scopes.length-1]._test=e};self.routines["iftrue"]=self.routines["ift"]=function(e){e=reparse(lexpr(e));var t=self.scopes[self.scopes.length-1]._test;if(t){self.execute(e)}};self.routines["iffalse"]=self.routines["iff"]=function(e){e=reparse(lexpr(e));var t=self.scopes[self.scopes.length-1]._test;if(!t){self.execute(e)}};self.routines["stop"]=function(){throw new Output};self.routines["output"]=self.routines["op"]=function(e){throw new Output(e)};self.routines["bye"]=function(){throw new Bye};self.routines[".maybeoutput"]=function(e){if(e!==void 0){throw new Output(e)}else{throw new Output}};self.routines["ignore"]=function(e){};self.routines["for"]=function(e,t){function n(e){return e<0?-1:e>0?1:0}e=reparse(lexpr(e));t=reparse(lexpr(t));var r=sexpr(e.shift());var i=aexpr(self.evaluateExpression(e));var s=aexpr(self.evaluateExpression(e));var o;var u=i;while(n(u-s)!==n(o)){self.setvar(r,u);self.execute(t);o=e.length?aexpr(self.evaluateExpression(e.slice())):n(s-i);u+=o}};self.routines["do.while"]=function(e,t){e=checkevalblock(e);do{self.execute(e)}while(t())};self.routines["do.while"].noeval=true;self.routines["while"]=function(e,t){t=checkevalblock(t);while(e()){self.execute(t)}};self.routines["while"].noeval=true;self.routines["do.until"]=function(e,t){e=checkevalblock(e);do{self.execute(e)}while(!t())};self.routines["do.until"].noeval=true;self.routines["until"]=function(e,t){t=checkevalblock(t);while(!e()){self.execute(t)}};self.routines["until"].noeval=true;self.routines["apply"]=function(e,t){e=sexpr(e).toLowerCase();var n=self.routines[e];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(n.special||n.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"APPLY",name:e.toUpperCase()}))}return n.apply(null,lexpr(t))};self.routines["invoke"]=function(e){e=sexpr(e).toLowerCase();var t=self.routines[e];if(!t){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(t.special||t.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"INVOKE",name:e.toUpperCase()}))}var n=[];for(var r=1;r<arguments.length;r+=1){n.push(arguments[r])}return t.apply(null,n)};self.routines["foreach"]=function(e,t){e=sexpr(e).toLowerCase();var n=self.routines[e];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(n.special||n.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"FOREACH",name:e.toUpperCase()}))}lexpr(t).forEach(n)};self.routines["map"]=function(e,t){e=sexpr(e).toLowerCase();var n=self.routines[e];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(n.special||n.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"MAP",name:e.toUpperCase()}))}return lexpr(t).map(n)};self.routines["filter"]=function(e,t){e=sexpr(e).toLowerCase();var n=self.routines[e];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(n.special||n.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"FILTER",name:e.toUpperCase()}))}return lexpr(t).filter(function(e){return n(e)})};self.routines["find"]=function(e,t){e=sexpr(e).toLowerCase();var n=self.routines[e];if(!n){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(n.special||n.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"FIND",name:e.toUpperCase()}))}t=lexpr(t);for(var r=0;r<t.length;r+=1){var i=t[r];if(n(i)){return i}}return[]};self.routines["reduce"]=function(e,t){e=sexpr(e).toLowerCase();t=lexpr(t);var n=arguments[2]!==void 0?arguments[2]:t.shift();var r=self.routines[e];if(!r){throw new Error(format(__("Don't know how to {name}"),{name:e.toUpperCase()}))}if(r.special||r.noeval){throw new Error(format(__("Can't apply {proc} to special {name}"),{proc:"REDUCE",name:e.toUpperCase()}))}return t.reduce(function(e,t){return r(e,t)},n)};Object.keys(self.routines).forEach(function(e){self.routines[gt[e]]=self.routines[e];self.routines[e].primitive=true})}function __(e){var t;if(typeof routines.translated==="object"&&(t=routines.translated[e]))return t;return e}var ratio=1